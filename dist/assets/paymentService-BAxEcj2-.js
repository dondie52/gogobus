import{b as e,M as t,n as a,o as n,s as o,l as r}from"./index-CHY3DGCF.js";import{validateUUID as s,validateAmount as i,validateEmail as d,validatePhone as c,sanitizeObject as u}from"./validation-DjNTQiWP.js";const m={NETWORK_ERROR:"NETWORK_ERROR",TIMEOUT:"TIMEOUT",CONNECTION_FAILED:"CONNECTION_FAILED",INSUFFICIENT_FUNDS:"INSUFFICIENT_FUNDS",PAYMENT_CANCELLED:"PAYMENT_CANCELLED",PAYMENT_FAILED:"PAYMENT_FAILED",INVALID_CARD:"INVALID_CARD",EXPIRED_CARD:"EXPIRED_CARD",DECLINED:"DECLINED",DPO_INVALID_TOKEN:"DPO_INVALID_TOKEN",DPO_EXPIRED_TOKEN:"DPO_EXPIRED_TOKEN",DPO_INVALID_AMOUNT:"DPO_INVALID_AMOUNT",ORANGE_INVALID_PHONE:"ORANGE_INVALID_PHONE",ORANGE_USER_CANCELLED:"ORANGE_USER_CANCELLED",ORANGE_TIMEOUT:"ORANGE_TIMEOUT",UNKNOWN_ERROR:"UNKNOWN_ERROR",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",INVALID_REQUEST:"INVALID_REQUEST"},l={[m.NETWORK_ERROR]:"Connection failed. Please check your internet connection and try again.",[m.TIMEOUT]:"Request timed out. Please try again.",[m.CONNECTION_FAILED]:"Unable to connect to payment service. Please try again later.",[m.INSUFFICIENT_FUNDS]:"Insufficient funds. Please try another payment method or add funds to your account.",[m.PAYMENT_CANCELLED]:"Payment was cancelled. You can try again when ready.",[m.PAYMENT_FAILED]:"Payment failed. Please check your payment details and try again.",[m.INVALID_CARD]:"Invalid card details. Please check your card number and try again.",[m.EXPIRED_CARD]:"Your card has expired. Please use a different card.",[m.DECLINED]:"Payment was declined by your bank. Please contact your bank or try another payment method.",[m.DPO_INVALID_TOKEN]:"Payment session expired. Please start a new payment.",[m.DPO_EXPIRED_TOKEN]:"Payment session expired. Please start a new payment.",[m.DPO_INVALID_AMOUNT]:"Invalid payment amount. Please contact support.",[m.ORANGE_INVALID_PHONE]:"Invalid phone number. Please check your Orange Money phone number.",[m.ORANGE_USER_CANCELLED]:"Payment was cancelled. Please try again when ready.",[m.ORANGE_TIMEOUT]:"Payment timed out. Please try again.",[m.UNKNOWN_ERROR]:"An unexpected error occurred. Please try again or contact support.",[m.SERVICE_UNAVAILABLE]:"Payment service is temporarily unavailable. Please try again later.",[m.INVALID_REQUEST]:"Invalid payment request. Please check your details and try again."},p=e=>{var t;if(!e)return m.UNKNOWN_ERROR;const a=(null==(t=e.message)?void 0:t.toLowerCase())||"",n=e.toString().toLowerCase();return a.includes("network")||a.includes("fetch")||a.includes("connection")?m.NETWORK_ERROR:a.includes("timeout")||n.includes("timeout")?m.TIMEOUT:a.includes("insufficient")||a.includes("funds")?m.INSUFFICIENT_FUNDS:a.includes("cancelled")||a.includes("cancel")?m.PAYMENT_CANCELLED:a.includes("declined")||a.includes("rejected")?m.DECLINED:a.includes("expired")?m.EXPIRED_CARD:a.includes("invalid card")||a.includes("card number")?m.INVALID_CARD:a.includes("dpo")&&a.includes("token")?m.DPO_INVALID_TOKEN:a.includes("orange")&&a.includes("phone")?m.ORANGE_INVALID_PHONE:m.UNKNOWN_ERROR},y=e=>{const t=p(e);return l[t]||l[m.UNKNOWN_ERROR]},f=async(t,a,n={})=>{try{const o={error_code:p(a),error_message:a.message||a.toString(),error_stack:a.stack,context:JSON.stringify(n),created_at:(new Date).toISOString()},{error:r}=await t.from("payment_errors").insert(o);r&&e("Payment Error",o)}catch(o){e("Failed to log payment error",o)}},g={API_URL:"https://secure.3gdirectpay.com/API/v6/",COMPANY_TOKEN:"",SERVICE_TYPE:"",CURRENCY:"BWP",COUNTRY:"BW"},_={API_URL:"https://api.orange.com/orange-money-webpay/bw/v1",MERCHANT_KEY:"",RETURN_URL:"",CANCEL_URL:"",NOTIF_URL:""},E={SUCCESS_URL:"/booking/confirmation",CANCEL_URL:"/booking/payment",WEBHOOK_URL:"/api/payment/webhook"},h={CARD:{id:"card",name:"Credit/Debit Card",description:"Pay with Visa or Mastercard",icon:"card",enabled:!0,provider:"dpo",fees:{type:"percentage",value:2.5}},ORANGE_MONEY:{id:"orange_money",name:"Orange Money",description:"Pay with Orange Money wallet",icon:"orange",enabled:!0,provider:"orange",fees:{type:"flat",value:5}},MYZAKA:{id:"myzaka",name:"Mascom MyZaka",description:"Pay with MyZaka mobile money",icon:"myzaka",enabled:!0,provider:"dpo",fees:{type:"flat",value:5}},SMEGA:{id:"smega",name:"BTC Smega",description:"Pay with Smega mobile money",icon:"smega",enabled:!0,provider:"dpo",fees:{type:"flat",value:5}},BANK_TRANSFER:{id:"bank_transfer",name:"Bank Transfer",description:"Pay via EFT bank transfer",icon:"bank",enabled:!0,provider:"manual",fees:{type:"flat",value:0}},CASH:{id:"cash",name:"Pay at Station",description:"Pay cash at the bus station",icon:"cash",enabled:!0,provider:"manual",fees:{type:"flat",value:0}}},I=(e,t)=>{const a=h[e.toUpperCase()]||h.CARD,{fees:n}=a;return"percentage"===n.type?Math.round(t*(n.value/100)*100)/100:n.value},N=()=>`GGB-${Date.now().toString(36)}-${Math.random().toString(36).substring(2,8)}`.toUpperCase(),O=e=>Math.round(100*e),R=async t=>{var a,n,r,m,l,p;const{bookingId:_,amount:h,customerEmail:I,customerName:O,customerPhone:R,description:w,paymentMethod:v="card"}=t;if(fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:163",message:"createDPOPayment entry",data:{bookingId:_,isValidUUID:s(_),amount:h},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{}),!_||!s(_))throw fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:175",message:"Invalid bookingId validation",data:{bookingId:_,isValidUUID:s(_)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{}),new Error("Invalid booking ID");if(!h||!i(h))throw new Error("Invalid payment amount");if(!I||!d(I))throw new Error("Invalid customer email");if(R&&!c(R))throw new Error("Invalid customer phone number");const b=N();try{const{data:e}=await o.auth.getSession(),{data:t}=await o.from("bookings").select("id, user_id").eq("id",_).single();fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:190",message:"Before payment insert - auth and booking check",data:{authUid:null==(n=null==(a=null==e?void 0:e.session)?void 0:a.user)?void 0:n.id,bookingExists:!!t,bookingUserId:null==t?void 0:t.user_id,bookingId:_,userIdMatches:(null==(m=null==(r=null==e?void 0:e.session)?void 0:r.user)?void 0:m.id)===(null==t?void 0:t.user_id)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{});const s=u({customerEmail:I,customerName:O,customerPhone:R,description:w}),{data:i,error:d}=await o.from("payments").insert({booking_id:_,transaction_ref:b,amount:h,currency:g.CURRENCY,payment_method:v,provider:"dpo",status:"pending",customer_email:s.customerEmail,customer_name:s.customerName,customer_phone:s.customerPhone,metadata:{description:s.description}}).select().single();if(fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:217",message:"Payment insert result",data:{paymentCreated:!!i,error:null==d?void 0:d.message,errorCode:null==d?void 0:d.code,errorDetails:null==d?void 0:d.details,errorHint:null==d?void 0:d.hint},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),d)throw d;const c={CompanyToken:g.COMPANY_TOKEN,Request:"createToken",Transaction:{PaymentAmount:h.toFixed(2),PaymentCurrency:g.CURRENCY,CompanyRef:b,RedirectURL:`${window.location.origin}${E.SUCCESS_URL}?ref=${b}`,BackURL:`${window.location.origin}${E.CANCEL_URL}?ref=${b}`,CompanyRefUnique:1,PTL:30},Services:{Service:{ServiceType:g.SERVICE_TYPE,ServiceDescription:w||"GOGOBUS Bus Ticket",ServiceDate:(new Date).toISOString().split("T")[0]}},Customer:{CustomerFirstName:(null==(l=s.customerName)?void 0:l.split(" ")[0])||"Customer",CustomerLastName:(null==(p=s.customerName)?void 0:p.split(" ").slice(1).join(" "))||"",CustomerEmail:s.customerEmail,CustomerPhone:s.customerPhone,CustomerCountry:g.COUNTRY}},y=await P("createToken",c);if("000"!==y.Result)throw new Error(y.ResultExplanation||"Payment initiation failed");return await o.from("payments").update({provider_token:y.TransToken,provider_ref:y.TransRef}).eq("id",i.id),{success:!0,transactionRef:b,paymentId:i.id,token:y.TransToken,paymentUrl:`https://secure.3gdirectpay.com/payv2.php?ID=${y.TransToken}`}}catch(D){return e("DPO Payment Error",D),await f(o,D,{action:"createDPOPayment",bookingId:_,transactionRef:b}),{success:!1,error:y(D)}}},w=async t=>{try{const{data:e,error:a}=await o.from("payments").select("*").eq("transaction_ref",t).single();if(a||!e)throw new Error("Payment not found");if(!e.provider_token)throw new Error("No payment token found");const n={CompanyToken:g.COMPANY_TOKEN,Request:"verifyToken",TransactionToken:e.provider_token},r=await P("verifyToken",n);let s="pending";"000"===r.Result?s="completed":"901"===r.Result?s="failed":"904"===r.Result&&(s="cancelled");const{data:i}=await o.from("payments").update({status:s,provider_status:r.ResultExplanation,completed_at:"completed"===s?(new Date).toISOString():null}).eq("id",e.id).select().single();return"completed"===s&&await o.from("bookings").update({payment_status:"paid",payment_method:e.payment_method,payment_reference:t}).eq("id",e.booking_id),{success:"completed"===s,status:s,payment:i,message:r.ResultExplanation}}catch(a){return e("DPO Verification Error",a),await f(o,a,{action:"verifyDPOPayment",transactionRef:t}),{success:!1,status:"error",error:y(a)}}},P=async(e,t)=>(r("DPO credentials not configured. Using mock response."),v(e,t)),v=(e,t)=>{var a;return"createToken"===e?{Result:"000",ResultExplanation:"Transaction created successfully",TransToken:"MOCK-TOKEN-"+Date.now(),TransRef:"MOCK-REF-"+Date.now()}:"verifyToken"===e?{Result:"000",ResultExplanation:"Transaction paid",TransactionAmount:(null==(a=t.Transaction)?void 0:a.PaymentAmount)||"",TransactionCurrency:"BWP"}:{Result:"999",ResultExplanation:"Unknown action"}},b=async t=>{var a,n,r,i;const{bookingId:d,amount:c,customerPhone:u,customerName:m,description:l}=t;fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:603",message:"createOrangeMoneyPayment entry",data:{bookingId:d,isValidUUID:s(d),amount:c},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});const p=N();try{const{data:e}=await o.auth.getSession(),{data:t}=await o.from("bookings").select("id, user_id").eq("id",d).single();fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:614",message:"Before orange payment insert - auth and booking check",data:{authUid:null==(n=null==(a=null==e?void 0:e.session)?void 0:a.user)?void 0:n.id,bookingExists:!!t,bookingUserId:null==t?void 0:t.user_id,bookingId:d,userIdMatches:(null==(i=null==(r=null==e?void 0:e.session)?void 0:r.user)?void 0:i.id)===(null==t?void 0:t.user_id)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{});const{data:s,error:y}=await o.from("payments").insert({booking_id:d,transaction_ref:p,amount:c,currency:"BWP",payment_method:"orange_money",provider:"orange",status:"pending",customer_phone:u,customer_name:m,metadata:{description:l}}).select().single();if(fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:633",message:"Orange payment insert result",data:{paymentCreated:!!s,error:null==y?void 0:y.message,errorCode:null==y?void 0:y.code,errorDetails:null==y?void 0:y.details,errorHint:null==y?void 0:y.hint},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),y)throw y;const f={merchant_key:_.MERCHANT_KEY,currency:"OUV",order_id:p,amount:O(c),return_url:`${window.location.origin}${E.SUCCESS_URL}?ref=${p}`,cancel_url:`${window.location.origin}${E.CANCEL_URL}?ref=${p}`,notif_url:`${window.location.origin}${E.WEBHOOK_URL}`,lang:"en",reference:l||"GOGOBUS Bus Ticket"},g=await C("init",f);if("INITIATED"!==g.status)throw new Error(g.message||"Orange Money payment initiation failed");return await o.from("payments").update({provider_ref:g.pay_token,provider_token:g.payment_url}).eq("id",s.id),{success:!0,transactionRef:p,paymentId:s.id,paymentUrl:g.payment_url,payToken:g.pay_token}}catch(g){return e("Orange Money Error",g),await f(o,g,{action:"createOrangeMoneyPayment",bookingId:d,transactionRef:p}),{success:!1,error:y(g)}}},D=async t=>{try{const{data:e}=await o.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");const a=await C("status",{order_id:t,pay_token:e.provider_ref});let n="pending";return"SUCCESS"===a.status?n="completed":"FAILED"===a.status?n="failed":"CANCELLED"===a.status&&(n="cancelled"),await o.from("payments").update({status:n,provider_status:a.status,completed_at:"completed"===n?(new Date).toISOString():null}).eq("id",e.id),"completed"===n&&await o.from("bookings").update({payment_status:"paid",payment_method:"orange_money",payment_reference:t}).eq("id",e.booking_id),{success:"completed"===n,status:n}}catch(a){return e("Orange Money Verification Error",a),await f(o,a,{action:"verifyOrangeMoneyPayment",transactionRef:t}),{success:!1,status:"error",error:y(a)}}},C=async(e,t)=>(r("Orange Money credentials not configured. Using mock response."),T(e)),T=(e,t)=>"init"===e?{status:"INITIATED",pay_token:"OM-TOKEN-"+Date.now(),payment_url:`https://mock-orange-pay.com/pay?token=OM-TOKEN-${Date.now()}`}:"status"===e?{status:"SUCCESS"}:{status:"ERROR",message:"Unknown action"},k=async t=>{var a,n,r,i;const{bookingId:d,amount:c,paymentMethod:u,customerName:m,customerPhone:l,notes:p}=t;fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:986",message:"createManualPayment entry",data:{bookingId:d,isValidUUID:s(d),amount:c,paymentMethod:u},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});const y=N();try{const{data:e}=await o.auth.getSession(),{data:t}=await o.from("bookings").select("id, user_id").eq("id",d).single();fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:998",message:"Before manual payment insert - auth and booking check",data:{authUid:null==(n=null==(a=null==e?void 0:e.session)?void 0:a.user)?void 0:n.id,bookingExists:!!t,bookingUserId:null==t?void 0:t.user_id,bookingId:d,userIdMatches:(null==(i=null==(r=null==e?void 0:e.session)?void 0:r.user)?void 0:i.id)===(null==t?void 0:t.user_id)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{});const{data:s,error:f}=await o.from("payments").insert({booking_id:d,transaction_ref:y,amount:c,currency:"BWP",payment_method:u,provider:"manual",status:"pending",customer_name:m,customer_phone:l,metadata:{notes:p,requires_confirmation:!0}}).select().single();if(fetch("http://127.0.0.1:7244/ingest/c4c33fba-1ee4-4b2f-aa1a-ed506c7c702f",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"paymentService.js:1016",message:"Manual payment insert result",data:{paymentCreated:!!s,error:null==f?void 0:f.message,errorCode:null==f?void 0:f.code,errorDetails:null==f?void 0:f.details,errorHint:null==f?void 0:f.hint},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),f)throw f;return await o.from("bookings").update({payment_status:"pending",payment_method:u}).eq("id",d),{success:!0,transactionRef:y,paymentId:s.id,message:"cash"===u?"Please pay at the bus station before departure":"Please complete the bank transfer and upload proof of payment",bankDetails:"bank_transfer"===u?{bankName:"First National Bank Botswana",accountName:"GOGOBUS (Pty) Ltd",accountNumber:"62XXXXXXXX",branchCode:"282267",reference:y}:null}}catch(f){return e("Manual Payment Error",f),{success:!1,error:f.message}}},S={PAYMENT_METHODS:h,getEnabledPaymentMethods:()=>Object.values(h).filter(e=>e.enabled),calculateFees:I,calculateTotal:(e,t,a)=>{const n=I(a,e);return{baseAmount:e,serviceFee:t,paymentFee:n,total:e+t+n}},initiatePayment:async e=>{const{paymentMethod:t}=e,a=h[t.toUpperCase()];if(!a||!a.enabled)return{success:!1,error:"Invalid or disabled payment method"};switch(a.provider){case"dpo":return R(e);case"orange":return b(e);case"manual":return k(e);default:return{success:!1,error:"Unknown payment provider"}}},verifyPayment:async e=>{try{const{data:t}=await o.from("payments").select("*").eq("transaction_ref",e).single();if(!t)throw new Error("Payment not found");switch(t.provider){case"dpo":return w(e);case"orange":return D(e);case"manual":return{success:"completed"===t.status,status:t.status,payment:t};default:return{success:!1,error:"Unknown provider"}}}catch(t){return{success:!1,error:t.message}}},getPaymentByRef:async e=>{const{data:t,error:a}=await o.from("payments").select("\n      *,\n      bookings (\n        id,\n        booking_reference,\n        passenger_name,\n        trips (\n          departure_time,\n          routes (origin, destination)\n        )\n      )\n    ").eq("transaction_ref",e).single();return a?{data:null,error:a}:{data:t,error:null}},getBookingPayments:async e=>{const{data:t,error:a}=await o.from("payments").select("*").eq("booking_id",e).order("created_at",{ascending:!1});return a?{data:[],error:a}:{data:t,error:null}},createDPOPayment:R,verifyDPOPayment:w,createOrangeMoneyPayment:b,verifyOrangeMoneyPayment:D,pollOrangeMoneyStatus:async(e,t=12e4)=>{const a=Date.now();return new Promise((n,r)=>{const s=async()=>{try{if(Date.now()-a>t)return void r(new Error("Payment polling timeout"));const{data:i}=await o.from("payments").select("*").eq("transaction_ref",e).single();if(!i||!i.provider_ref)return void r(new Error("Payment not found"));const d=await C("status",{order_id:e,pay_token:i.provider_ref});let c="pending";if("SUCCESS"===d.status||"PAID"===d.status?c="completed":"FAILED"===d.status||"ERROR"===d.status?c="failed":"CANCELLED"===d.status&&(c="cancelled"),await o.from("payments").update({status:c,provider_status:d.status,completed_at:"completed"===c?(new Date).toISOString():null}).eq("id",i.id),"completed"===c||"failed"===c||"cancelled"===c)return"completed"===c&&await o.from("bookings").update({payment_status:"paid",payment_method:"orange_money",payment_reference:e}).eq("id",i.booking_id),void n({success:"completed"===c,status:c,payment:i});setTimeout(s,5e3)}catch(i){if(!i.message.includes("timeout"))return void r(i);Date.now()-a<t?setTimeout(s,5e3):r(new Error("Payment polling timeout"))}};s()})},createManualPayment:k,confirmManualPayment:async(t,a)=>{try{const{data:e}=await o.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");return await o.from("payments").update({status:"completed",completed_at:(new Date).toISOString(),confirmed_by:a}).eq("id",e.id),await o.from("bookings").update({payment_status:"paid",payment_reference:t}).eq("id",e.booking_id),{success:!0}}catch(n){return e("Manual Payment Confirmation Error",n),{success:!1,error:n.message}}},requestRefund:async(t,a,n)=>{try{const{data:e}=await o.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");if("completed"!==e.status)throw new Error("Payment not completed");const{data:r,error:s}=await o.from("refunds").insert({payment_id:e.id,booking_id:e.booking_id,amount:e.amount,reason:a,status:"pending",requested_by:n}).select().single();if(s)throw s;return await o.from("payments").update({status:"refund_requested"}).eq("id",e.id),{success:!0,refund:r}}catch(r){return e("Refund Request Error",r),{success:!1,error:r.message}}},processRefund:async(t,a,n)=>{try{const{data:i}=await o.from("refunds").select("*, payments(*)").eq("id",t).single();if(!i)throw new Error("Refund not found");const d=n?"approved":"rejected";if(await o.from("refunds").update({status:d,processed_by:a,processed_at:(new Date).toISOString()}).eq("id",t),n){const a=i.payments;let n=null;try{"dpo"===a.provider&&a.provider_token?n=await(async()=>(r("DPO credentials not configured. Skipping refund API call."),{success:!0,providerRef:"MOCK-REFUND-"+Date.now()}))(a.provider_token,i.amount,i.reason):"orange"===a.provider&&a.provider_ref&&(n=await(async()=>(r("Orange Money credentials not configured. Skipping refund API call."),{success:!0,providerRef:"MOCK-REFUND-"+Date.now()}))(a.transaction_ref,a.provider_ref,i.amount,i.reason)),n&&n.providerRef&&await o.from("refunds").update({provider_ref:n.providerRef,status:"processing"}).eq("id",t)}catch(s){e("Provider refund API error",s),await f(o,s,{action:"processRefund",refundId:t,provider:a.provider})}await o.from("payments").update({status:"refunded"}).eq("id",i.payment_id),await o.from("bookings").update({payment_status:"refunded"}).eq("id",i.booking_id)}else await o.from("payments").update({status:"completed"}).eq("id",i.payment_id);return{success:!0,status:d}}catch(i){return e("Process Refund Error",i),await f(o,i,{action:"processRefund",refundId:t}),{success:!1,error:y(i)}}}};export{S as p};
