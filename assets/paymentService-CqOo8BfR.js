import{c as e,M as t,R as a,x as n,s as r,y as o,z as s,v as i,f as c,A as d,l as m}from"./index-DRtgfs52.js";import{e as u}from"./emailService-CcOtE1-p.js";const l={NETWORK_ERROR:"NETWORK_ERROR",TIMEOUT:"TIMEOUT",CONNECTION_FAILED:"CONNECTION_FAILED",INSUFFICIENT_FUNDS:"INSUFFICIENT_FUNDS",PAYMENT_CANCELLED:"PAYMENT_CANCELLED",PAYMENT_FAILED:"PAYMENT_FAILED",INVALID_CARD:"INVALID_CARD",EXPIRED_CARD:"EXPIRED_CARD",DECLINED:"DECLINED",DPO_INVALID_TOKEN:"DPO_INVALID_TOKEN",DPO_EXPIRED_TOKEN:"DPO_EXPIRED_TOKEN",DPO_INVALID_AMOUNT:"DPO_INVALID_AMOUNT",ORANGE_INVALID_PHONE:"ORANGE_INVALID_PHONE",ORANGE_USER_CANCELLED:"ORANGE_USER_CANCELLED",ORANGE_TIMEOUT:"ORANGE_TIMEOUT",UNKNOWN_ERROR:"UNKNOWN_ERROR",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",INVALID_REQUEST:"INVALID_REQUEST"},p={[l.NETWORK_ERROR]:"Connection failed. Please check your internet connection and try again.",[l.TIMEOUT]:"Request timed out. Please try again.",[l.CONNECTION_FAILED]:"Unable to connect to payment service. Please try again later.",[l.INSUFFICIENT_FUNDS]:"Insufficient funds. Please try another payment method or add funds to your account.",[l.PAYMENT_CANCELLED]:"Payment was cancelled. You can try again when ready.",[l.PAYMENT_FAILED]:"Payment failed. Please check your payment details and try again.",[l.INVALID_CARD]:"Invalid card details. Please check your card number and try again.",[l.EXPIRED_CARD]:"Your card has expired. Please use a different card.",[l.DECLINED]:"Payment was declined by your bank. Please contact your bank or try another payment method.",[l.DPO_INVALID_TOKEN]:"Payment session expired. Please start a new payment.",[l.DPO_EXPIRED_TOKEN]:"Payment session expired. Please start a new payment.",[l.DPO_INVALID_AMOUNT]:"Invalid payment amount. Please contact support.",[l.ORANGE_INVALID_PHONE]:"Invalid phone number. Please check your Orange Money phone number.",[l.ORANGE_USER_CANCELLED]:"Payment was cancelled. Please try again when ready.",[l.ORANGE_TIMEOUT]:"Payment timed out. Please try again.",[l.UNKNOWN_ERROR]:"An unexpected error occurred. Please try again or contact support.",[l.SERVICE_UNAVAILABLE]:"Payment service is temporarily unavailable. Please try again later.",[l.INVALID_REQUEST]:"Invalid payment request. Please check your details and try again."},y=e=>{var t;if(!e)return l.UNKNOWN_ERROR;const a=(null==(t=e.message)?void 0:t.toLowerCase())||"",n=e.toString().toLowerCase();return a.includes("network")||a.includes("fetch")||a.includes("connection")?l.NETWORK_ERROR:a.includes("timeout")||n.includes("timeout")?l.TIMEOUT:a.includes("insufficient")||a.includes("funds")?l.INSUFFICIENT_FUNDS:a.includes("cancelled")||a.includes("cancel")?l.PAYMENT_CANCELLED:a.includes("declined")||a.includes("rejected")?l.DECLINED:a.includes("expired")?l.EXPIRED_CARD:a.includes("invalid card")||a.includes("card number")?l.INVALID_CARD:a.includes("dpo")&&a.includes("token")?l.DPO_INVALID_TOKEN:a.includes("orange")&&a.includes("phone")?l.ORANGE_INVALID_PHONE:l.UNKNOWN_ERROR},_=e=>{const t=y(e);return p[t]||p[l.UNKNOWN_ERROR]},f=async(t,a,n={})=>{try{const r={error_code:y(a),error_message:a.message||a.toString(),error_stack:a.stack,context:JSON.stringify(n),created_at:(new Date).toISOString()},{error:o}=await t.from("payment_errors").insert(r);o&&e("Payment Error",r)}catch(r){e("Failed to log payment error",r)}},E={API_URL:"https://secure.3gdirectpay.com/API/v6/",COMPANY_TOKEN:"",SERVICE_TYPE:"",CURRENCY:"BWP",COUNTRY:"BW"},g={API_URL:"https://api.orange.com/orange-money-webpay/bw/v1",MERCHANT_KEY:"",RETURN_URL:"",CANCEL_URL:"",NOTIF_URL:""},N={SUCCESS_URL:"/booking/confirmation",CANCEL_URL:"/booking/payment",WEBHOOK_URL:"/api/payment/webhook"},R={CARD:{id:"card",name:"Credit/Debit Card",description:"Pay with Visa or Mastercard",icon:"card",enabled:!0,provider:"dpo",fees:{type:"percentage",value:2.5}},ORANGE_MONEY:{id:"orange_money",name:"Orange Money",description:"Pay with Orange Money wallet",icon:"orange",enabled:!0,provider:"orange",fees:{type:"flat",value:5}},MYZAKA:{id:"myzaka",name:"Mascom MyZaka",description:"Pay with MyZaka mobile money",icon:"myzaka",enabled:!0,provider:"dpo",fees:{type:"flat",value:5}},SMEGA:{id:"smega",name:"BTC Smega",description:"Pay with Smega mobile money",icon:"smega",enabled:!0,provider:"dpo",fees:{type:"flat",value:5}},BANK_TRANSFER:{id:"bank_transfer",name:"Bank Transfer",description:"Pay via EFT bank transfer",icon:"bank",enabled:!0,provider:"manual",fees:{type:"flat",value:0}},CASH:{id:"cash",name:"Pay at Station",description:"Pay cash at the bus station",icon:"cash",enabled:!0,provider:"manual",fees:{type:"flat",value:0}}},w=(e,t)=>{const a=R[e.toUpperCase()]||R.CARD,{fees:n}=a;return"percentage"===n.type?Math.round(t*(n.value/100)*100)/100:n.value},P=()=>`GGB-${Date.now().toString(36)}-${Math.random().toString(36).substring(2,8)}`.toUpperCase(),I=e=>Math.round(100*e),O=async t=>{try{const{data:e,error:a}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(a||!e)throw new Error("Payment not found");if(!e.provider_token)throw new Error("No payment token found");const n={CompanyToken:E.COMPANY_TOKEN,Request:"verifyToken",TransactionToken:e.provider_token},o=await k("verifyToken",n);let s="pending";"000"===o.Result?s="completed":"901"===o.Result?s="failed":"904"===o.Result&&(s="cancelled");const{data:i}=await r.from("payments").update({status:s,provider_status:o.ResultExplanation,completed_at:"completed"===s?(new Date).toISOString():null}).eq("id",e.id).select().single();return"completed"===s&&await r.from("bookings").update({payment_status:"paid",payment_method:e.payment_method,payment_reference:t}).eq("id",e.booking_id),{success:"completed"===s,status:s,payment:i,message:o.ResultExplanation}}catch(a){return e("DPO Verification Error",a),await f(r,a,{action:"verifyDPOPayment",transactionRef:t}),{success:!1,status:"error",error:_(a)}}},k=async(e,t)=>(m("DPO credentials not configured. Using mock response."),D(e,t)),D=(e,t)=>{var a;return"createToken"===e?{Result:"000",ResultExplanation:"Transaction created successfully",TransToken:"MOCK-TOKEN-"+Date.now(),TransRef:"MOCK-REF-"+Date.now()}:"verifyToken"===e?{Result:"000",ResultExplanation:"Transaction paid",TransactionAmount:(null==(a=t.Transaction)?void 0:a.PaymentAmount)||"",TransactionCurrency:"BWP"}:{Result:"999",ResultExplanation:"Unknown action"}},C=async t=>{try{const{data:e}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");const a=await h("status",{order_id:t,pay_token:e.provider_ref});let n="pending";return"SUCCESS"===a.status?n="completed":"FAILED"===a.status?n="failed":"CANCELLED"===a.status&&(n="cancelled"),await r.from("payments").update({status:n,provider_status:a.status,completed_at:"completed"===n?(new Date).toISOString():null}).eq("id",e.id),"completed"===n&&await r.from("bookings").update({payment_status:"paid",payment_method:"orange_money",payment_reference:t}).eq("id",e.booking_id),{success:"completed"===n,status:n}}catch(a){return e("Orange Money Verification Error",a),await f(r,a,{action:"verifyOrangeMoneyPayment",transactionRef:t}),{success:!1,status:"error",error:_(a)}}},h=async(e,t)=>(m("Orange Money credentials not configured. Using mock response."),A(e)),A=(e,t)=>"init"===e?{status:"INITIATED",pay_token:"OM-TOKEN-"+Date.now(),payment_url:`https://mock-orange-pay.com/pay?token=OM-TOKEN-${Date.now()}`}:"status"===e?{status:"SUCCESS"}:{status:"ERROR",message:"Unknown action"},T=async t=>{const{bookingId:a,amount:n,paymentMethod:o,customerName:s,customerEmail:i,customerPhone:c,description:l}=t,p=`MOCK-${Date.now()}`;try{if(!a)throw new Error("Booking ID is required");if(!n||n<=0)throw new Error("Invalid payment amount");const t=d({customerEmail:i,customerName:s,customerPhone:c,description:l}),{data:_,error:f}=await r.from("payments").insert({booking_id:a,transaction_ref:p,amount:n,currency:"BWP",payment_method:o,provider:"mock",status:"completed",customer_email:t.customerEmail,customer_name:t.customerName,customer_phone:t.customerPhone,metadata:{description:t.description,is_mock:!0,note:"Mock payment - payment will be completed at station"},completed_at:(new Date).toISOString()}).select().single();if(f)throw f;const{error:E}=await r.from("bookings").update({payment_status:"paid",payment_method:o,payment_reference:p,status:"confirmed",updated_at:(new Date).toISOString()}).eq("id",a);E&&e("Failed to update booking status",E);try{const{data:e}=await r.from("bookings").select("*, schedule:schedules(departure_time, route:routes(origin, destination))").eq("id",a).single();if(e){const a=e.schedule,r=null==a?void 0:a.route;await u.sendBookingConfirmation({bookingId:e.id,customerEmail:t.customerEmail,customerName:t.customerName,origin:e.origin||(null==r?void 0:r.origin)||"Unknown",destination:e.destination||(null==r?void 0:r.destination)||"Unknown",departureTime:e.departure_time||(null==a?void 0:a.departure_time)||"",seats:Array.isArray(e.seats)?e.seats:[],totalAmount:n,bookingRef:e.booking_ref||e.id})}}catch(y){m("Failed to send booking confirmation email",y)}return{success:!0,transactionRef:p,paymentId:_.id,message:"Payment completed (mock) - ticket reserved"}}catch(_){return e("Mock Payment Error",_),await f(r,_,{action:"mockConfirmPayment",bookingId:a,transactionRef:p}),{success:!1,error:_.message||"Mock payment failed"}}},v={PAYMENT_METHODS:R,getEnabledPaymentMethods:()=>Object.values(R).filter(e=>e.enabled),calculateFees:w,calculateTotal:(e,t,a)=>{const n=w(a,e);return{baseAmount:e,serviceFee:t,paymentFee:n,total:e+t+n}},initiatePayment:async e=>T(e),verifyPayment:async e=>{try{const{data:t}=await r.from("payments").select("*").eq("transaction_ref",e).single();if(!t)throw new Error("Payment not found");switch(t.provider){case"dpo":return O(e);case"orange":return C(e);case"manual":return{success:"completed"===t.status,status:t.status,payment:t};default:return{success:!1,error:"Unknown provider"}}}catch(t){return{success:!1,error:t.message}}},getPaymentByRef:async e=>{const{data:t,error:a}=await r.from("payments").select("\n      *,\n      bookings (\n        id,\n        booking_reference,\n        passenger_name,\n        trips (\n          departure_time,\n          routes (origin, destination)\n        )\n      )\n    ").eq("transaction_ref",e).single();return a?{data:null,error:a}:{data:t,error:null}},getBookingPayments:async e=>{const{data:t,error:a}=await r.from("payments").select("*").eq("booking_id",e).order("created_at",{ascending:!1});return a?{data:[],error:a}:{data:t,error:null}},mockConfirmPayment:T,createDPOPayment:async t=>{var a,n;const{bookingId:m,amount:u,customerEmail:l,customerName:p,customerPhone:y,description:g,paymentMethod:R="card"}=t;if(!m||!o(m))throw new Error("Invalid booking ID");if(!u||!s(u))throw new Error("Invalid payment amount");if(!l||!i(l))throw new Error("Invalid customer email");if(y&&!c(y))throw new Error("Invalid customer phone number");const w=P();try{const{data:e}=await r.auth.getSession(),{data:t}=await r.from("bookings").select("id, user_id").eq("id",m).single(),o=d({customerEmail:l,customerName:p,customerPhone:y,description:g}),{data:s,error:i}=await r.from("payments").insert({booking_id:m,transaction_ref:w,amount:u,currency:E.CURRENCY,payment_method:R,provider:"dpo",status:"pending",customer_email:o.customerEmail,customer_name:o.customerName,customer_phone:o.customerPhone,metadata:{description:o.description}}).select().single();if(i)throw i;const c={CompanyToken:E.COMPANY_TOKEN,Request:"createToken",Transaction:{PaymentAmount:u.toFixed(2),PaymentCurrency:E.CURRENCY,CompanyRef:w,RedirectURL:`${window.location.origin}${N.SUCCESS_URL}?ref=${w}`,BackURL:`${window.location.origin}${N.CANCEL_URL}?ref=${w}`,CompanyRefUnique:1,PTL:30},Services:{Service:{ServiceType:E.SERVICE_TYPE,ServiceDescription:g||"GOGOBUS Bus Ticket",ServiceDate:(new Date).toISOString().split("T")[0]}},Customer:{CustomerFirstName:(null==(a=o.customerName)?void 0:a.split(" ")[0])||"Customer",CustomerLastName:(null==(n=o.customerName)?void 0:n.split(" ").slice(1).join(" "))||"",CustomerEmail:o.customerEmail,CustomerPhone:o.customerPhone,CustomerCountry:E.COUNTRY}},_=await k("createToken",c);if("000"!==_.Result)throw new Error(_.ResultExplanation||"Payment initiation failed");return await r.from("payments").update({provider_token:_.TransToken,provider_ref:_.TransRef}).eq("id",s.id),{success:!0,transactionRef:w,paymentId:s.id,token:_.TransToken,paymentUrl:`https://secure.3gdirectpay.com/payv2.php?ID=${_.TransToken}`}}catch(I){return e("DPO Payment Error",I),await f(r,I,{action:"createDPOPayment",bookingId:m,transactionRef:w}),{success:!1,error:_(I)}}},verifyDPOPayment:O,createOrangeMoneyPayment:async t=>{const{bookingId:a,amount:n,customerPhone:o,customerName:s,description:i}=t,c=P();try{const{data:e}=await r.auth.getSession(),{data:t}=await r.from("bookings").select("id, user_id").eq("id",a).single(),{data:d,error:m}=await r.from("payments").insert({booking_id:a,transaction_ref:c,amount:n,currency:"BWP",payment_method:"orange_money",provider:"orange",status:"pending",customer_phone:o,customer_name:s,metadata:{description:i}}).select().single();if(m)throw m;const u={merchant_key:g.MERCHANT_KEY,currency:"OUV",order_id:c,amount:I(n),return_url:`${window.location.origin}${N.SUCCESS_URL}?ref=${c}`,cancel_url:`${window.location.origin}${N.CANCEL_URL}?ref=${c}`,notif_url:`${window.location.origin}${N.WEBHOOK_URL}`,lang:"en",reference:i||"GOGOBUS Bus Ticket"},l=await h("init",u);if("INITIATED"!==l.status)throw new Error(l.message||"Orange Money payment initiation failed");return await r.from("payments").update({provider_ref:l.pay_token,provider_token:l.payment_url}).eq("id",d.id),{success:!0,transactionRef:c,paymentId:d.id,paymentUrl:l.payment_url,payToken:l.pay_token}}catch(d){return e("Orange Money Error",d),await f(r,d,{action:"createOrangeMoneyPayment",bookingId:a,transactionRef:c}),{success:!1,error:_(d)}}},verifyOrangeMoneyPayment:C,pollOrangeMoneyStatus:async(e,t=12e4)=>{const a=Date.now();return new Promise((n,o)=>{const s=async()=>{try{if(Date.now()-a>t)return void o(new Error("Payment polling timeout"));const{data:i}=await r.from("payments").select("*").eq("transaction_ref",e).single();if(!i||!i.provider_ref)return void o(new Error("Payment not found"));const c=await h("status",{order_id:e,pay_token:i.provider_ref});let d="pending";if("SUCCESS"===c.status||"PAID"===c.status?d="completed":"FAILED"===c.status||"ERROR"===c.status?d="failed":"CANCELLED"===c.status&&(d="cancelled"),await r.from("payments").update({status:d,provider_status:c.status,completed_at:"completed"===d?(new Date).toISOString():null}).eq("id",i.id),"completed"===d||"failed"===d||"cancelled"===d)return"completed"===d&&await r.from("bookings").update({payment_status:"paid",payment_method:"orange_money",payment_reference:e}).eq("id",i.booking_id),void n({success:"completed"===d,status:d,payment:i});setTimeout(s,5e3)}catch(i){if(!i.message.includes("timeout"))return void o(i);Date.now()-a<t?setTimeout(s,5e3):o(new Error("Payment polling timeout"))}};s()})},createManualPayment:async t=>{const{bookingId:a,amount:n,paymentMethod:o,customerName:s,customerPhone:i,notes:c}=t,d=P();try{const{data:e}=await r.auth.getSession(),{data:t}=await r.from("bookings").select("id, user_id").eq("id",a).single(),{data:m,error:u}=await r.from("payments").insert({booking_id:a,transaction_ref:d,amount:n,currency:"BWP",payment_method:o,provider:"manual",status:"pending",customer_name:s,customer_phone:i,metadata:{notes:c,requires_confirmation:!0}}).select().single();if(u)throw u;return await r.from("bookings").update({payment_status:"pending",payment_method:o}).eq("id",a),{success:!0,transactionRef:d,paymentId:m.id,message:"cash"===o?"Please pay at the bus station before departure":"Please complete the bank transfer and upload proof of payment",bankDetails:"bank_transfer"===o?{bankName:"First National Bank Botswana",accountName:"GOGOBUS (Pty) Ltd",accountNumber:"62XXXXXXXX",branchCode:"282267",reference:d}:null}}catch(m){return e("Manual Payment Error",m),{success:!1,error:m.message}}},confirmManualPayment:async(t,a)=>{try{const{data:e}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");return await r.from("payments").update({status:"completed",completed_at:(new Date).toISOString(),confirmed_by:a}).eq("id",e.id),await r.from("bookings").update({payment_status:"paid",payment_reference:t}).eq("id",e.booking_id),{success:!0}}catch(n){return e("Manual Payment Confirmation Error",n),{success:!1,error:n.message}}},requestRefund:async(t,a,n)=>{try{const{data:e}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");if("completed"!==e.status)throw new Error("Payment not completed");const{data:o,error:s}=await r.from("refunds").insert({payment_id:e.id,booking_id:e.booking_id,amount:e.amount,reason:a,status:"pending",requested_by:n}).select().single();if(s)throw s;return await r.from("payments").update({status:"refund_requested"}).eq("id",e.id),{success:!0,refund:o}}catch(o){return e("Refund Request Error",o),{success:!1,error:o.message}}},processRefund:async(t,a,n)=>{try{const{data:s}=await r.from("refunds").select("*, payments(*)").eq("id",t).single();if(!s)throw new Error("Refund not found");const i=n?"approved":"rejected";if(await r.from("refunds").update({status:i,processed_by:a,processed_at:(new Date).toISOString()}).eq("id",t),n){const a=s.payments;let n=null;try{"dpo"===a.provider&&a.provider_token?n=await(async()=>(m("DPO credentials not configured. Skipping refund API call."),{success:!0,providerRef:"MOCK-REFUND-"+Date.now()}))(a.provider_token,s.amount,s.reason):"orange"===a.provider&&a.provider_ref&&(n=await(async()=>(m("Orange Money credentials not configured. Skipping refund API call."),{success:!0,providerRef:"MOCK-REFUND-"+Date.now()}))(a.transaction_ref,a.provider_ref,s.amount,s.reason)),n&&n.providerRef&&await r.from("refunds").update({provider_ref:n.providerRef,status:"processing"}).eq("id",t)}catch(o){e("Provider refund API error",o),await f(r,o,{action:"processRefund",refundId:t,provider:a.provider})}await r.from("payments").update({status:"refunded"}).eq("id",s.payment_id),await r.from("bookings").update({payment_status:"refunded"}).eq("id",s.booking_id)}else await r.from("payments").update({status:"completed"}).eq("id",s.payment_id);return{success:!0,status:i}}catch(s){return e("Process Refund Error",s),await f(r,s,{action:"processRefund",refundId:t}),{success:!1,error:_(s)}}}};export{v as p};
