import{s as e,b as t}from"./index-CHY3DGCF.js";import{validateBookingInput as a,validateUUID as r,sanitizeObject as i}from"./validation-DjNTQiWP.js";const s={async searchTrips({origin:t,destination:a,date:r,passengers:i}){const s=new Date(r);s.setHours(0,0,0,0);const n=new Date(r);n.setHours(23,59,59,999);const{data:o,error:u}=await e.from("schedules").select("\n        *,\n        route:routes(*),\n        bus:buses(*)\n      ").eq("status","active").gte("departure_time",s.toISOString()).lte("departure_time",n.toISOString()).gte("available_seats",i||1).order("departure_time");if(u)return{data:null,error:u};return{data:o.filter(e=>{var r,i;const s=e.route;if(!s)return!1;const n=null==(r=s.origin)?void 0:r.toLowerCase().includes(t.toLowerCase()),o=null==(i=s.destination)?void 0:i.toLowerCase().includes(a.toLowerCase());return n&&o}).map(e=>{const t=e.route||{},a=e.bus||{},r=t.duration_hours?Math.round(60*t.duration_hours):null;return{id:e.id,departure_time:e.departure_time,arrival_time:e.arrival_time,price:parseFloat(e.price),available_seats:e.available_seats,routes:{id:t.id,origin:t.origin,destination:t.destination,distance_km:t.distance_km,duration_minutes:r},buses:{id:a.id,bus_name:a.plate_number||"Standard Bus",bus_type:a.bus_type||"standard",capacity:a.capacity||40,amenities:Array.isArray(a.amenities)?a.amenities:[]}}}),error:null}},async getTripById(t){const{data:a,error:r}=await e.from("schedules").select("\n        *,\n        route:routes(*),\n        bus:buses(*)\n      ").eq("id",t).single();if(r)return{data:null,error:r};const i=a.route||{},s=a.bus||{},n=i.duration_hours?Math.round(60*i.duration_hours):null,o=s.capacity||40,u=a.seat_map||[],d=[],l=Math.ceil(o/4),c=["A","B","C","D"],m=new Set;Array.isArray(u)&&u.forEach(e=>{"string"==typeof e?m.add(e):e&&e.seat_number&&m.add(e.seat_number)});for(let e=1;e<=l;e++){for(let t=0;t<c.length;t++){const r=c[t],i=`${e}${r}`,s=m.has(i);if(d.length>=o)break;d.push({id:`${a.id}-${i}`,seat_number:i,seat_row:e.toString(),seat_column:r,is_available:!s})}if(d.length>=o)break}return{data:{id:a.id,departure_time:a.departure_time,arrival_time:a.arrival_time,price:parseFloat(a.price),available_seats:a.available_seats,routes:{id:i.id,origin:i.origin,destination:i.destination,distance_km:i.distance_km,duration_minutes:n},buses:{id:s.id,bus_name:s.plate_number||"Standard Bus",bus_type:s.bus_type||"standard",capacity:s.capacity||40,amenities:Array.isArray(s.amenities)?s.amenities:[]},seats:d},error:null}},async searchSchedules(t,a,r){const i=new Date(r);i.setHours(0,0,0,0);const s=new Date(r);s.setHours(23,59,59,999);const{data:n,error:o}=await e.from("schedules").select("\n        *,\n        route:routes(*),\n        bus:buses(*, company:companies(*))\n      ").eq("status","active").gte("departure_time",i.toISOString()).lte("departure_time",s.toISOString()).gt("available_seats",0).order("departure_time");if(o)throw o;return n.filter(e=>e.route.origin.toLowerCase().includes(t.toLowerCase())&&e.route.destination.toLowerCase().includes(a.toLowerCase())).map(e=>{var t,a,i,s;const n=new Date(e.departure_time),o=new Date(e.arrival_time),u=o-n,d=Math.floor(u/36e5),l=Math.floor(u%36e5/6e4);return{id:e.id,company:{name:(null==(a=null==(t=e.bus)?void 0:t.company)?void 0:a.name)||"Unknown",logo:"ðŸšŒ"},departure_time:n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),arrival_time:o.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),duration:`${d}h ${l}m`,price:parseFloat(e.price),available_seats:e.available_seats,amenities:(null==(i=e.bus)?void 0:i.amenities)||[],bus_type:(null==(s=e.bus)?void 0:s.bus_type)||"Standard",origin:e.route.origin,destination:e.route.destination,date:r}})},async createBooking(s){try{const t=a(s);if(!t.valid)throw new Error(t.errors.join(", "));if(s.schedule_id&&!r(s.schedule_id))throw new Error("Invalid schedule ID");if(s.user_id&&!r(s.user_id))throw new Error("Invalid user ID");const n=i(s),{data:o,error:u}=await e.from("bookings").insert(n).select().single();if(u)throw u;if(s.schedule_id&&s.seats){const t=Array.isArray(s.seats)?s.seats.map(e=>"string"==typeof e?e:e.seat_number||e):[s.seats],{data:a,error:r}=await e.from("schedules").select("seat_map, available_seats").eq("id",s.schedule_id).single();if(!r&&a){const r=Array.isArray(a.seat_map)?a.seat_map:[],i=[...new Set([...r,...t])],n=Math.max(0,(a.available_seats||0)-t.length);await e.from("schedules").update({seat_map:i,available_seats:n}).eq("id",s.schedule_id)}}return o}catch(n){throw t("Error creating booking",n),n}},async getUserBookings(t){const{data:a,error:r}=await e.from("bookings").select("\n        *,\n        schedule:schedules(\n          *,\n          route:routes(*),\n          bus:buses(*, company:companies(*))\n        )\n      ").eq("user_id",t).order("created_at",{ascending:!1});if(r)throw r;return a},async cancelBooking(t){const{data:a,error:r}=await e.from("bookings").update({status:"cancelled"}).eq("id",t).select().single();if(r)throw r;return a}};export{s as b};
