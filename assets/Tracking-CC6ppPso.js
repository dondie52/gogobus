import{w as n,u as s,a as e,r as a,j as l,s as t}from"./index-S2ZdPJqa.js";import{s as i,b as r,a as c,T as d,g as o}from"./trackingService-ClyeaWrg.js";const _="_container_hzlqn_1",h="_loadingScreen_hzlqn_11",u="_errorScreen_hzlqn_12",m="_loadingSpinner_hzlqn_22",x="_errorIcon_hzlqn_42",j="_backButton_hzlqn_61",N="_header_hzlqn_77",v="_backBtn_hzlqn_88",p="_headerTitle_hzlqn_105",q="_mapArea_hzlqn_114",z="_sheet_hzlqn_120",g="_expanded_hzlqn_136",f="_sheetHandle_hzlqn_140",k="_handleBar_hzlqn_151",b="_sheetContent_hzlqn_158",S="_routeInfo_hzlqn_165",$="_routePoint_hzlqn_174",y="_routeDot_hzlqn_180",C="_origin_hzlqn_187",w="_destination_hzlqn_191",D="_routeLabel_hzlqn_195",I="_routeValue_hzlqn_202",L="_routeLine_hzlqn_210",B="_detailsGrid_hzlqn_217",E="_detailItem_hzlqn_224",T="_detailLabel_hzlqn_230",M="_detailValue_hzlqn_236",U="_liveIndicator_hzlqn_243",G="_liveDot_hzlqn_257",O="_adminPanel_hzlqn_270",V="_adminHeader_hzlqn_278",F="_adminContent_hzlqn_289",H="_simButton_hzlqn_295",P="_startBtn_hzlqn_306",A="_stopBtn_hzlqn_315",J="_adminNote_hzlqn_324";function R(n){if(!n)return"Unknown";const s=new Date(n),e=new Date-s,a=Math.floor(e/1e3),l=Math.floor(a/60);return a<10?"Just now":a<60?`${a}s ago`:l<60?`${l}m ago`:s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Y(){const{routeId:Y}=n(),K=s(),{user:Q,profile:W}=e(),[X,Z]=a.useState(null),[nn,sn]=a.useState(null),[en,an]=a.useState(!0),[ln,tn]=a.useState(null),[rn,cn]=a.useState(null),[dn,on]=a.useState(!1),[_n,hn]=a.useState(!1),un=a.useRef(null),mn="admin"===(null==W?void 0:W.role);a.useEffect(()=>{Y&&async function(){try{const{data:n,error:s}=await t.from("routes").select("*").eq("id",Y).single();if(s)throw s;sn(n)}catch(n){}}()},[Y]),a.useEffect(()=>{if(!Y)return tn("No route ID provided"),void an(!1);let n=!0;return async function(){try{an(!0);const s=await o(Y);n&&(Z(s),cn((null==s?void 0:s.recorded_at)||null))}catch(s){n&&tn("Failed to load tracking data")}finally{n&&an(!1)}}(),()=>{n=!1}},[Y]),a.useEffect(()=>{if(!Y)return;const n=i(Y,n=>{Z(n),cn((null==n?void 0:n.recorded_at)||(new Date).toISOString())});return()=>{n()}},[Y]),a.useEffect(()=>()=>{un.current&&un.current()},[]),a.useEffect(()=>{if(!rn)return;const n=setInterval(()=>{cn(n=>n)},1e4);return()=>clearInterval(n)},[rn]);const xn=a.useCallback(()=>{K(-1)},[K]),jn=a.useCallback(()=>{on(n=>!n)},[]),Nn=a.useCallback(async()=>{if(_n||!Y)return;hn(!0);const n=nn?{lat:nn.origin_lat||-24.6282,lng:nn.origin_lng||25.9231}:{lat:-24.6282,lng:25.9231},s=nn?{lat:nn.destination_lat||-24.658,lng:nn.destination_lng||25.912}:{lat:-24.658,lng:25.912};try{const e=await r(Y,{start:n,end:s,duration:45e3,interval:3e3,onUpdate:n=>{}});un.current=e,setTimeout(()=>{hn(!1),un.current=null},5e4)}catch(e){hn(!1)}},[_n,Y,nn]),vn=a.useCallback(()=>{un.current&&(un.current(),un.current=null),hn(!1)},[]);if(en)return l.jsx("div",{className:_,children:l.jsxs("div",{className:h,children:[l.jsx("div",{className:m}),l.jsx("p",{children:"Loading tracking data..."})]})});if(ln)return l.jsx("div",{className:_,children:l.jsxs("div",{className:u,children:[l.jsx("span",{className:x,children:"‚ö†Ô∏è"}),l.jsx("h2",{children:"Unable to Load Tracking"}),l.jsx("p",{children:ln}),l.jsx("button",{className:j,onClick:xn,type:"button",children:"Go Back"})]})});const pn=nn?{lat:nn.origin_lat,lng:nn.origin_lng,name:nn.origin}:null,qn=nn?{lat:nn.destination_lat,lng:nn.destination_lng,name:nn.destination}:null;return l.jsxs("div",{className:_,children:[l.jsxs("header",{className:N,children:[l.jsx("button",{className:v,onClick:xn,type:"button","aria-label":"Go back",children:"‚Üê"}),l.jsx("h1",{className:p,children:"Live Tracking"}),(null==X?void 0:X.status)&&l.jsx(c,{status:X.status,size:"small"})]}),l.jsx("div",{className:q,children:l.jsx(d,{location:X,origin:pn,destination:qn})}),l.jsxs("div",{className:`${z} ${dn?g:""}`,children:[l.jsx("button",{className:f,onClick:jn,type:"button","aria-label":dn?"Collapse details":"Expand details",children:l.jsx("span",{className:k})}),l.jsxs("div",{className:b,children:[l.jsxs("div",{className:S,children:[l.jsxs("div",{className:$,children:[l.jsx("span",{className:`${y} ${C}`}),l.jsxs("div",{children:[l.jsx("span",{className:D,children:"From"}),l.jsx("span",{className:I,children:(null==nn?void 0:nn.origin)||"Origin"})]})]}),l.jsx("div",{className:L}),l.jsxs("div",{className:$,children:[l.jsx("span",{className:`${y} ${w}`}),l.jsxs("div",{children:[l.jsx("span",{className:D,children:"To"}),l.jsx("span",{className:I,children:(null==nn?void 0:nn.destination)||"Destination"})]})]})]}),l.jsxs("div",{className:B,children:[l.jsxs("div",{className:E,children:[l.jsx("span",{className:T,children:"Distance"}),l.jsx("span",{className:M,children:(null==nn?void 0:nn.distance_km)?`${nn.distance_km} km`:"--"})]}),l.jsxs("div",{className:E,children:[l.jsx("span",{className:T,children:"Duration"}),l.jsx("span",{className:M,children:(null==nn?void 0:nn.duration_hours)?`${Math.round(60*nn.duration_hours)} min`:"--"})]}),l.jsxs("div",{className:E,children:[l.jsx("span",{className:T,children:"Speed"}),l.jsx("span",{className:M,children:null!=(null==X?void 0:X.speed)?`${Math.round(X.speed)} km/h`:"-- km/h"})]}),l.jsxs("div",{className:E,children:[l.jsx("span",{className:T,children:"Updated"}),l.jsx("span",{className:M,children:R(rn)})]})]}),l.jsxs("div",{className:U,children:[l.jsx("span",{className:G}),l.jsx("span",{children:"Live tracking active"})]}),mn&&l.jsxs("div",{className:O,children:[l.jsxs("div",{className:V,children:[l.jsx("span",{children:"üõ†Ô∏è"}),l.jsx("span",{children:"DEV ONLY - Simulation"})]}),l.jsxs("div",{className:F,children:[_n?l.jsx("button",{className:`${H} ${A}`,onClick:vn,type:"button",children:"‚èπ Stop Simulation"}):l.jsx("button",{className:`${H} ${P}`,onClick:Nn,type:"button",children:"‚ñ∂Ô∏è Simulate Movement"}),l.jsx("p",{className:J,children:"Simulates bus movement for ~45 seconds"})]})]})]})]})]})}export{Y as default};
