import{c as e,M as t,n as a,o as n,s as r,l as o}from"./index-DzaH6n5y.js";import{validateUUID as s,validateAmount as i,validateEmail as c,validatePhone as d,sanitizeObject as u}from"./validation-DjNTQiWP.js";const m={NETWORK_ERROR:"NETWORK_ERROR",TIMEOUT:"TIMEOUT",CONNECTION_FAILED:"CONNECTION_FAILED",INSUFFICIENT_FUNDS:"INSUFFICIENT_FUNDS",PAYMENT_CANCELLED:"PAYMENT_CANCELLED",PAYMENT_FAILED:"PAYMENT_FAILED",INVALID_CARD:"INVALID_CARD",EXPIRED_CARD:"EXPIRED_CARD",DECLINED:"DECLINED",DPO_INVALID_TOKEN:"DPO_INVALID_TOKEN",DPO_EXPIRED_TOKEN:"DPO_EXPIRED_TOKEN",DPO_INVALID_AMOUNT:"DPO_INVALID_AMOUNT",ORANGE_INVALID_PHONE:"ORANGE_INVALID_PHONE",ORANGE_USER_CANCELLED:"ORANGE_USER_CANCELLED",ORANGE_TIMEOUT:"ORANGE_TIMEOUT",UNKNOWN_ERROR:"UNKNOWN_ERROR",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",INVALID_REQUEST:"INVALID_REQUEST"},p={[m.NETWORK_ERROR]:"Connection failed. Please check your internet connection and try again.",[m.TIMEOUT]:"Request timed out. Please try again.",[m.CONNECTION_FAILED]:"Unable to connect to payment service. Please try again later.",[m.INSUFFICIENT_FUNDS]:"Insufficient funds. Please try another payment method or add funds to your account.",[m.PAYMENT_CANCELLED]:"Payment was cancelled. You can try again when ready.",[m.PAYMENT_FAILED]:"Payment failed. Please check your payment details and try again.",[m.INVALID_CARD]:"Invalid card details. Please check your card number and try again.",[m.EXPIRED_CARD]:"Your card has expired. Please use a different card.",[m.DECLINED]:"Payment was declined by your bank. Please contact your bank or try another payment method.",[m.DPO_INVALID_TOKEN]:"Payment session expired. Please start a new payment.",[m.DPO_EXPIRED_TOKEN]:"Payment session expired. Please start a new payment.",[m.DPO_INVALID_AMOUNT]:"Invalid payment amount. Please contact support.",[m.ORANGE_INVALID_PHONE]:"Invalid phone number. Please check your Orange Money phone number.",[m.ORANGE_USER_CANCELLED]:"Payment was cancelled. Please try again when ready.",[m.ORANGE_TIMEOUT]:"Payment timed out. Please try again.",[m.UNKNOWN_ERROR]:"An unexpected error occurred. Please try again or contact support.",[m.SERVICE_UNAVAILABLE]:"Payment service is temporarily unavailable. Please try again later.",[m.INVALID_REQUEST]:"Invalid payment request. Please check your details and try again."},l=e=>{var t;if(!e)return m.UNKNOWN_ERROR;const a=(null==(t=e.message)?void 0:t.toLowerCase())||"",n=e.toString().toLowerCase();return a.includes("network")||a.includes("fetch")||a.includes("connection")?m.NETWORK_ERROR:a.includes("timeout")||n.includes("timeout")?m.TIMEOUT:a.includes("insufficient")||a.includes("funds")?m.INSUFFICIENT_FUNDS:a.includes("cancelled")||a.includes("cancel")?m.PAYMENT_CANCELLED:a.includes("declined")||a.includes("rejected")?m.DECLINED:a.includes("expired")?m.EXPIRED_CARD:a.includes("invalid card")||a.includes("card number")?m.INVALID_CARD:a.includes("dpo")&&a.includes("token")?m.DPO_INVALID_TOKEN:a.includes("orange")&&a.includes("phone")?m.ORANGE_INVALID_PHONE:m.UNKNOWN_ERROR},y=e=>{const t=l(e);return p[t]||p[m.UNKNOWN_ERROR]},_=async(t,a,n={})=>{try{const r={error_code:l(a),error_message:a.message||a.toString(),error_stack:a.stack,context:JSON.stringify(n),created_at:(new Date).toISOString()},{error:o}=await t.from("payment_errors").insert(r);o&&e("Payment Error",r)}catch(r){e("Failed to log payment error",r)}},E={API_URL:"https://secure.3gdirectpay.com/API/v6/",COMPANY_TOKEN:"",SERVICE_TYPE:"",CURRENCY:"BWP",COUNTRY:"BW"},f={API_URL:"https://api.orange.com/orange-money-webpay/bw/v1",MERCHANT_KEY:"",RETURN_URL:"",CANCEL_URL:"",NOTIF_URL:""},N={SUCCESS_URL:"/booking/confirmation",CANCEL_URL:"/booking/payment",WEBHOOK_URL:"/api/payment/webhook"},g={CARD:{id:"card",name:"Credit/Debit Card",description:"Pay with Visa or Mastercard",icon:"card",enabled:!0,provider:"dpo",fees:{type:"percentage",value:2.5}},ORANGE_MONEY:{id:"orange_money",name:"Orange Money",description:"Pay with Orange Money wallet",icon:"orange",enabled:!0,provider:"orange",fees:{type:"flat",value:5}},MYZAKA:{id:"myzaka",name:"Mascom MyZaka",description:"Pay with MyZaka mobile money",icon:"myzaka",enabled:!0,provider:"dpo",fees:{type:"flat",value:5}},SMEGA:{id:"smega",name:"BTC Smega",description:"Pay with Smega mobile money",icon:"smega",enabled:!0,provider:"dpo",fees:{type:"flat",value:5}},BANK_TRANSFER:{id:"bank_transfer",name:"Bank Transfer",description:"Pay via EFT bank transfer",icon:"bank",enabled:!0,provider:"manual",fees:{type:"flat",value:0}},CASH:{id:"cash",name:"Pay at Station",description:"Pay cash at the bus station",icon:"cash",enabled:!0,provider:"manual",fees:{type:"flat",value:0}}},R=(e,t)=>{const a=g[e.toUpperCase()]||g.CARD,{fees:n}=a;return"percentage"===n.type?Math.round(t*(n.value/100)*100)/100:n.value},w=()=>`GGB-${Date.now().toString(36)}-${Math.random().toString(36).substring(2,8)}`.toUpperCase(),O=e=>Math.round(100*e),P=async t=>{var a,n;const{bookingId:o,amount:m,customerEmail:p,customerName:l,customerPhone:f,description:g,paymentMethod:R="card"}=t;if(!o||!s(o))throw new Error("Invalid booking ID");if(!m||!i(m))throw new Error("Invalid payment amount");if(!p||!c(p))throw new Error("Invalid customer email");if(f&&!d(f))throw new Error("Invalid customer phone number");const O=w();try{const{data:e}=await r.auth.getSession(),{data:t}=await r.from("bookings").select("id, user_id").eq("id",o).single(),s=u({customerEmail:p,customerName:l,customerPhone:f,description:g}),{data:i,error:c}=await r.from("payments").insert({booking_id:o,transaction_ref:O,amount:m,currency:E.CURRENCY,payment_method:R,provider:"dpo",status:"pending",customer_email:s.customerEmail,customer_name:s.customerName,customer_phone:s.customerPhone,metadata:{description:s.description}}).select().single();if(c)throw c;const d={CompanyToken:E.COMPANY_TOKEN,Request:"createToken",Transaction:{PaymentAmount:m.toFixed(2),PaymentCurrency:E.CURRENCY,CompanyRef:O,RedirectURL:`${window.location.origin}${N.SUCCESS_URL}?ref=${O}`,BackURL:`${window.location.origin}${N.CANCEL_URL}?ref=${O}`,CompanyRefUnique:1,PTL:30},Services:{Service:{ServiceType:E.SERVICE_TYPE,ServiceDescription:g||"GOGOBUS Bus Ticket",ServiceDate:(new Date).toISOString().split("T")[0]}},Customer:{CustomerFirstName:(null==(a=s.customerName)?void 0:a.split(" ")[0])||"Customer",CustomerLastName:(null==(n=s.customerName)?void 0:n.split(" ").slice(1).join(" "))||"",CustomerEmail:s.customerEmail,CustomerPhone:s.customerPhone,CustomerCountry:E.COUNTRY}},y=await D("createToken",d);if("000"!==y.Result)throw new Error(y.ResultExplanation||"Payment initiation failed");return await r.from("payments").update({provider_token:y.TransToken,provider_ref:y.TransRef}).eq("id",i.id),{success:!0,transactionRef:O,paymentId:i.id,token:y.TransToken,paymentUrl:`https://secure.3gdirectpay.com/payv2.php?ID=${y.TransToken}`}}catch(P){return e("DPO Payment Error",P),await _(r,P,{action:"createDPOPayment",bookingId:o,transactionRef:O}),{success:!1,error:y(P)}}},I=async t=>{try{const{data:e,error:a}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(a||!e)throw new Error("Payment not found");if(!e.provider_token)throw new Error("No payment token found");const n={CompanyToken:E.COMPANY_TOKEN,Request:"verifyToken",TransactionToken:e.provider_token},o=await D("verifyToken",n);let s="pending";"000"===o.Result?s="completed":"901"===o.Result?s="failed":"904"===o.Result&&(s="cancelled");const{data:i}=await r.from("payments").update({status:s,provider_status:o.ResultExplanation,completed_at:"completed"===s?(new Date).toISOString():null}).eq("id",e.id).select().single();return"completed"===s&&await r.from("bookings").update({payment_status:"paid",payment_method:e.payment_method,payment_reference:t}).eq("id",e.booking_id),{success:"completed"===s,status:s,payment:i,message:o.ResultExplanation}}catch(a){return e("DPO Verification Error",a),await _(r,a,{action:"verifyDPOPayment",transactionRef:t}),{success:!1,status:"error",error:y(a)}}},D=async(e,t)=>(o("DPO credentials not configured. Using mock response."),C(e,t)),C=(e,t)=>{var a;return"createToken"===e?{Result:"000",ResultExplanation:"Transaction created successfully",TransToken:"MOCK-TOKEN-"+Date.now(),TransRef:"MOCK-REF-"+Date.now()}:"verifyToken"===e?{Result:"000",ResultExplanation:"Transaction paid",TransactionAmount:(null==(a=t.Transaction)?void 0:a.PaymentAmount)||"",TransactionCurrency:"BWP"}:{Result:"999",ResultExplanation:"Unknown action"}},A=async t=>{const{bookingId:a,amount:n,customerPhone:o,customerName:s,description:i}=t,c=w();try{const{data:e}=await r.auth.getSession(),{data:t}=await r.from("bookings").select("id, user_id").eq("id",a).single(),{data:d,error:u}=await r.from("payments").insert({booking_id:a,transaction_ref:c,amount:n,currency:"BWP",payment_method:"orange_money",provider:"orange",status:"pending",customer_phone:o,customer_name:s,metadata:{description:i}}).select().single();if(u)throw u;const m={merchant_key:f.MERCHANT_KEY,currency:"OUV",order_id:c,amount:O(n),return_url:`${window.location.origin}${N.SUCCESS_URL}?ref=${c}`,cancel_url:`${window.location.origin}${N.CANCEL_URL}?ref=${c}`,notif_url:`${window.location.origin}${N.WEBHOOK_URL}`,lang:"en",reference:i||"GOGOBUS Bus Ticket"},p=await h("init",m);if("INITIATED"!==p.status)throw new Error(p.message||"Orange Money payment initiation failed");return await r.from("payments").update({provider_ref:p.pay_token,provider_token:p.payment_url}).eq("id",d.id),{success:!0,transactionRef:c,paymentId:d.id,paymentUrl:p.payment_url,payToken:p.pay_token}}catch(d){return e("Orange Money Error",d),await _(r,d,{action:"createOrangeMoneyPayment",bookingId:a,transactionRef:c}),{success:!1,error:y(d)}}},T=async t=>{try{const{data:e}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");const a=await h("status",{order_id:t,pay_token:e.provider_ref});let n="pending";return"SUCCESS"===a.status?n="completed":"FAILED"===a.status?n="failed":"CANCELLED"===a.status&&(n="cancelled"),await r.from("payments").update({status:n,provider_status:a.status,completed_at:"completed"===n?(new Date).toISOString():null}).eq("id",e.id),"completed"===n&&await r.from("bookings").update({payment_status:"paid",payment_method:"orange_money",payment_reference:t}).eq("id",e.booking_id),{success:"completed"===n,status:n}}catch(a){return e("Orange Money Verification Error",a),await _(r,a,{action:"verifyOrangeMoneyPayment",transactionRef:t}),{success:!1,status:"error",error:y(a)}}},h=async(e,t)=>(o("Orange Money credentials not configured. Using mock response."),k(e)),k=(e,t)=>"init"===e?{status:"INITIATED",pay_token:"OM-TOKEN-"+Date.now(),payment_url:`https://mock-orange-pay.com/pay?token=OM-TOKEN-${Date.now()}`}:"status"===e?{status:"SUCCESS"}:{status:"ERROR",message:"Unknown action"},v=async t=>{const{bookingId:a,amount:n,paymentMethod:o,customerName:s,customerPhone:i,notes:c}=t,d=w();try{const{data:e}=await r.auth.getSession(),{data:t}=await r.from("bookings").select("id, user_id").eq("id",a).single(),{data:u,error:m}=await r.from("payments").insert({booking_id:a,transaction_ref:d,amount:n,currency:"BWP",payment_method:o,provider:"manual",status:"pending",customer_name:s,customer_phone:i,metadata:{notes:c,requires_confirmation:!0}}).select().single();if(m)throw m;return await r.from("bookings").update({payment_status:"pending",payment_method:o}).eq("id",a),{success:!0,transactionRef:d,paymentId:u.id,message:"cash"===o?"Please pay at the bus station before departure":"Please complete the bank transfer and upload proof of payment",bankDetails:"bank_transfer"===o?{bankName:"First National Bank Botswana",accountName:"GOGOBUS (Pty) Ltd",accountNumber:"62XXXXXXXX",branchCode:"282267",reference:d}:null}}catch(u){return e("Manual Payment Error",u),{success:!1,error:u.message}}},U={PAYMENT_METHODS:g,getEnabledPaymentMethods:()=>Object.values(g).filter(e=>e.enabled),calculateFees:R,calculateTotal:(e,t,a)=>{const n=R(a,e);return{baseAmount:e,serviceFee:t,paymentFee:n,total:e+t+n}},initiatePayment:async e=>{const{paymentMethod:t}=e,a=g[t.toUpperCase()];if(!a||!a.enabled)return{success:!1,error:"Invalid or disabled payment method"};switch(a.provider){case"dpo":return P(e);case"orange":return A(e);case"manual":return v(e);default:return{success:!1,error:"Unknown payment provider"}}},verifyPayment:async e=>{try{const{data:t}=await r.from("payments").select("*").eq("transaction_ref",e).single();if(!t)throw new Error("Payment not found");switch(t.provider){case"dpo":return I(e);case"orange":return T(e);case"manual":return{success:"completed"===t.status,status:t.status,payment:t};default:return{success:!1,error:"Unknown provider"}}}catch(t){return{success:!1,error:t.message}}},getPaymentByRef:async e=>{const{data:t,error:a}=await r.from("payments").select("\n      *,\n      bookings (\n        id,\n        booking_reference,\n        passenger_name,\n        trips (\n          departure_time,\n          routes (origin, destination)\n        )\n      )\n    ").eq("transaction_ref",e).single();return a?{data:null,error:a}:{data:t,error:null}},getBookingPayments:async e=>{const{data:t,error:a}=await r.from("payments").select("*").eq("booking_id",e).order("created_at",{ascending:!1});return a?{data:[],error:a}:{data:t,error:null}},createDPOPayment:P,verifyDPOPayment:I,createOrangeMoneyPayment:A,verifyOrangeMoneyPayment:T,pollOrangeMoneyStatus:async(e,t=12e4)=>{const a=Date.now();return new Promise((n,o)=>{const s=async()=>{try{if(Date.now()-a>t)return void o(new Error("Payment polling timeout"));const{data:i}=await r.from("payments").select("*").eq("transaction_ref",e).single();if(!i||!i.provider_ref)return void o(new Error("Payment not found"));const c=await h("status",{order_id:e,pay_token:i.provider_ref});let d="pending";if("SUCCESS"===c.status||"PAID"===c.status?d="completed":"FAILED"===c.status||"ERROR"===c.status?d="failed":"CANCELLED"===c.status&&(d="cancelled"),await r.from("payments").update({status:d,provider_status:c.status,completed_at:"completed"===d?(new Date).toISOString():null}).eq("id",i.id),"completed"===d||"failed"===d||"cancelled"===d)return"completed"===d&&await r.from("bookings").update({payment_status:"paid",payment_method:"orange_money",payment_reference:e}).eq("id",i.booking_id),void n({success:"completed"===d,status:d,payment:i});setTimeout(s,5e3)}catch(i){if(!i.message.includes("timeout"))return void o(i);Date.now()-a<t?setTimeout(s,5e3):o(new Error("Payment polling timeout"))}};s()})},createManualPayment:v,confirmManualPayment:async(t,a)=>{try{const{data:e}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");return await r.from("payments").update({status:"completed",completed_at:(new Date).toISOString(),confirmed_by:a}).eq("id",e.id),await r.from("bookings").update({payment_status:"paid",payment_reference:t}).eq("id",e.booking_id),{success:!0}}catch(n){return e("Manual Payment Confirmation Error",n),{success:!1,error:n.message}}},requestRefund:async(t,a,n)=>{try{const{data:e}=await r.from("payments").select("*").eq("transaction_ref",t).single();if(!e)throw new Error("Payment not found");if("completed"!==e.status)throw new Error("Payment not completed");const{data:o,error:s}=await r.from("refunds").insert({payment_id:e.id,booking_id:e.booking_id,amount:e.amount,reason:a,status:"pending",requested_by:n}).select().single();if(s)throw s;return await r.from("payments").update({status:"refund_requested"}).eq("id",e.id),{success:!0,refund:o}}catch(o){return e("Refund Request Error",o),{success:!1,error:o.message}}},processRefund:async(t,a,n)=>{try{const{data:i}=await r.from("refunds").select("*, payments(*)").eq("id",t).single();if(!i)throw new Error("Refund not found");const c=n?"approved":"rejected";if(await r.from("refunds").update({status:c,processed_by:a,processed_at:(new Date).toISOString()}).eq("id",t),n){const a=i.payments;let n=null;try{"dpo"===a.provider&&a.provider_token?n=await(async()=>(o("DPO credentials not configured. Skipping refund API call."),{success:!0,providerRef:"MOCK-REFUND-"+Date.now()}))(a.provider_token,i.amount,i.reason):"orange"===a.provider&&a.provider_ref&&(n=await(async()=>(o("Orange Money credentials not configured. Skipping refund API call."),{success:!0,providerRef:"MOCK-REFUND-"+Date.now()}))(a.transaction_ref,a.provider_ref,i.amount,i.reason)),n&&n.providerRef&&await r.from("refunds").update({provider_ref:n.providerRef,status:"processing"}).eq("id",t)}catch(s){e("Provider refund API error",s),await _(r,s,{action:"processRefund",refundId:t,provider:a.provider})}await r.from("payments").update({status:"refunded"}).eq("id",i.payment_id),await r.from("bookings").update({payment_status:"refunded"}).eq("id",i.booking_id)}else await r.from("payments").update({status:"completed"}).eq("id",i.payment_id);return{success:!0,status:c}}catch(i){return e("Process Refund Error",i),await _(r,i,{action:"processRefund",refundId:t}),{success:!1,error:y(i)}}}};export{U as p};
