import{s as e,l as r,c as t,A as a,O as n,B as o,D as i}from"./index-Ts2dcFCl.js";const s={async getAdminStats(){try{const r=new Date,a=new Date(r);a.setDate(r.getDate()-r.getDay()),a.setHours(0,0,0,0);const n=new Date(a);n.setDate(a.getDate()+7);const{data:o,error:i}=await e.from("bookings").select("*").gte("created_at",a.toISOString()).lte("created_at",n.toISOString());if(i)throw t("Error fetching bookings",i),i;const{data:s,error:u}=await e.from("schedules").select("id").neq("status","cancelled").gte("departure_time",(new Date).toISOString());if(u)throw t("Error fetching trips",u),u;const{data:d,error:l}=await e.from("routes").select("id").eq("is_active",!0);if(l)throw t("Error fetching routes",l),l;const c=(null==o?void 0:o.filter(e=>"confirmed"===e.status||"paid"===e.status||"paid"===e.payment_status))||[],g=c.reduce((e,r)=>e+(parseFloat(r.total_amount)||parseFloat(r.price)||0),0);return{data:{bookings_this_week:c.length,revenue_this_week:g,active_trips:(null==s?void 0:s.length)||0,total_routes:(null==d?void 0:d.length)||0},error:null}}catch(r){return t("Error getting admin stats",r),{data:{bookings_this_week:0,revenue_this_week:0,active_trips:0,total_routes:0},error:r}}},async getPopularRoutes(r=4){try{const{data:a,error:n}=await e.from("bookings").select("\n          id,\n          schedule:schedules!inner(\n            route_id,\n            route:routes!inner(\n              id,\n              origin,\n              destination\n            )\n          )\n        ").or("payment_status.eq.paid,status.eq.confirmed,status.eq.paid").limit(1e3);if(n)throw t("Error fetching popular routes",n),n;const o={};null==a||a.forEach(e=>{var r;const t=null==(r=e.schedule)?void 0:r.route;(null==t?void 0:t.id)&&(o[t.id]||(o[t.id]={name:`${t.origin} → ${t.destination}`,origin:t.origin,destination:t.destination,price:0,bookings:0}),o[t.id].bookings++)});return{data:Object.values(o).sort((e,r)=>r.bookings-e.bookings).slice(0,r),error:null}}catch(a){return t("Error getting popular routes",a),{data:[],error:a}}},async getTrips(r={}){try{let t=e.from("schedules").select("\n          *,\n          route:routes(*),\n          bus:buses(*)\n        ").order("departure_time",{ascending:!0});r.status&&(t=t.eq("status",r.status)),r.upcoming&&(t=t.gte("departure_time",(new Date).toISOString()));const{data:a,error:n}=await t;if(n)throw n;return{data:(a||[]).map(e=>{var r;return{id:e.id,route_id:e.route_id,bus_id:e.bus_id,departure_time:e.departure_time,arrival_time:e.arrival_time,price:e.price,total_seats:(null==(r=e.bus)?void 0:r.capacity)||40,available_seats:e.available_seats||0,status:e.status||"scheduled",routes:e.route,bus:e.bus}}),error:null}}catch(a){return t("Error getting trips",a),{data:[],error:a}}},async createTrip(r){try{if(!r.route_id||!a(r.route_id))throw new Error("Invalid route ID");if(!r.departure_time||!n(r.departure_time))throw new Error("Invalid departure time");if(!r.price||!o(r.price))throw new Error("Invalid price");const t=r.bus_id&&a(r.bus_id)?r.bus_id:null,s=i({route_id:r.route_id,bus_id:t,departure_time:r.departure_time,arrival_time:r.arrival_time||null,price:r.price,available_seats:r.total_seats||40,status:"scheduled"}),{data:u,error:d}=await e.from("schedules").insert(s).select().single();if(d)throw d;return{data:u,error:null}}catch(s){return t("Error creating trip",s),{data:null,error:s}}},async updateTrip(r,s){try{if(!a(r))throw new Error("Invalid trip ID");const t={};if(void 0!==s.route_id){if(!a(s.route_id))throw new Error("Invalid route ID");t.route_id=s.route_id}if(void 0!==s.bus_id&&(t.bus_id=s.bus_id&&a(s.bus_id)?s.bus_id:null),void 0!==s.departure_time){if(!n(s.departure_time))throw new Error("Invalid departure time");t.departure_time=s.departure_time}if(void 0!==s.arrival_time){if(s.arrival_time&&!n(s.arrival_time))throw new Error("Invalid arrival time");t.arrival_time=s.arrival_time}if(void 0!==s.price){if(!o(s.price))throw new Error("Invalid price");t.price=s.price}void 0!==s.total_seats&&(t.available_seats=s.total_seats);const u=i(t),{data:d,error:l}=await e.from("schedules").update(u).eq("id",r).select().single();if(l)throw l;return{data:d,error:null}}catch(u){return t("Error updating trip",u),{data:null,error:u}}},async updateTripStatus(r,a){try{const{data:t,error:n}=await e.from("schedules").update({status:a}).eq("id",r).select().single();if(n)throw n;return{data:t,error:null}}catch(n){return t("Error updating trip status",n),{data:null,error:n}}},async deleteTrip(r){try{const{data:t}=await e.from("bookings").select("id").eq("schedule_id",r).eq("status","confirmed").limit(1);if(t&&t.length>0){const{data:t,error:a}=await e.from("schedules").update({status:"cancelled"}).eq("id",r).select().single();if(a)throw a;return{data:t,cancelled:!0,error:null}}const{error:a}=await e.from("schedules").delete().eq("id",r);if(a)throw a;return{data:null,cancelled:!1,error:null}}catch(a){return t("Error deleting trip",a),{data:null,cancelled:!1,error:a}}},async getRoutes(r=!1){try{let t=e.from("routes").select("*").order("origin");r||(t=t.eq("is_active",!0));const{data:a,error:n}=await t;if(n)throw n;return{data:(a||[]).map(e=>({...e,duration_minutes:e.duration_minutes||(e.duration_hours?60*e.duration_hours:null)})),error:null}}catch(a){return t("Error getting routes",a),{data:[],error:a}}},async createRoute(r){try{const t={origin:r.origin,destination:r.destination,distance_km:r.distance_km||null,duration_minutes:r.duration_minutes||null,duration_hours:r.duration_minutes?r.duration_minutes/60:null,base_price:r.base_price,is_active:!0},{data:a,error:n}=await e.from("routes").insert(t).select().single();if(n)throw n;return{data:a,error:null}}catch(a){return t("Error creating route",a),{data:null,error:a}}},async updateRoute(r,a){try{const t={};void 0!==a.origin&&(t.origin=a.origin),void 0!==a.destination&&(t.destination=a.destination),void 0!==a.distance_km&&(t.distance_km=a.distance_km),void 0!==a.duration_minutes&&(t.duration_minutes=a.duration_minutes,t.duration_hours=a.duration_minutes?a.duration_minutes/60:null),void 0!==a.base_price&&(t.base_price=a.base_price);const{data:n,error:o}=await e.from("routes").update(t).eq("id",r).select().single();if(o)throw o;return{data:n,error:null}}catch(n){return t("Error updating route",n),{data:null,error:n}}},async deleteRoute(r){try{const{data:t}=await e.from("schedules").select("id").eq("route_id",r).gte("departure_time",(new Date).toISOString()).limit(1);if(t&&t.length>0){const{data:t,error:a}=await e.from("routes").update({is_active:!1}).eq("id",r).select().single();if(a)throw a;return{data:t,error:null}}const{error:a}=await e.from("routes").delete().eq("id",r);if(a)throw a;return{data:null,error:null}}catch(a){return t("Error deleting route",a),{data:null,error:a}}},async getBuses(){try{const{data:r,error:t}=await e.from("buses").select("*").order("bus_name");if(t)throw t;return{data:r||[],error:null}}catch(r){return t("Error getting buses",r),{data:[],error:r}}},async getBookings(r={}){try{let t=e.from("bookings").select("\n          *,\n          schedule:schedules(\n            *,\n            route:routes(*),\n            bus:buses(*)\n          )\n        ").order("created_at",{ascending:!1});if(r.paymentStatus&&(t=t.eq("payment_status",r.paymentStatus)),r.status&&(t=t.eq("status",r.status)),r.search){const e=`%${r.search}%`;t=t.or(`passenger_name.ilike.${e},passenger_phone.ilike.${e},booking_reference.ilike.${e}`)}const{data:a,error:n}=await t;if(n)throw n;return{data:(a||[]).map(e=>{var r;return{...e,trips:{...e.schedule,routes:null==(r=e.schedule)?void 0:r.route},passenger_name:e.passenger_name||"N/A",passenger_phone:e.passenger_phone||"N/A",seat_number:Array.isArray(e.seats)?e.seats.join(", "):e.seats||"N/A",payment_status:e.payment_status||"pending",total_amount:e.total_amount||e.price||0}}),error:null}}catch(a){return t("Error getting bookings",a),{data:[],error:a}}},async updateBookingStatus(r,a){try{const{data:t,error:n}=await e.from("bookings").update({status:a}).eq("id",r).select().single();if(n)throw n;return{data:t,error:null}}catch(n){return t("Error updating booking status",n),{data:null,error:n}}},async markAsBoarded(r){try{const{data:t,error:a}=await e.from("bookings").update({is_boarded:!0,boarded_at:(new Date).toISOString()}).eq("id",r).select().single();if(a)throw a;return{data:t,error:null}}catch(a){return t("Error marking as boarded",a),{data:null,error:a}}},async unmarkAsBoarded(r){try{const{data:t,error:a}=await e.from("bookings").update({is_boarded:!1,boarded_at:null}).eq("id",r).select().single();if(a)throw a;return{data:t,error:null}}catch(a){return t("Error unmarking as boarded",a),{data:null,error:a}}},async exportBookingsToCSV(e={}){try{const{data:r,error:t}=await this.getBookings(e);if(t||!(null==r?void 0:r.length))return null;const a=["Reference","Passenger Name","Phone","Email","Route","Departure Time","Seat","Amount","Payment Status","Booking Status","Boarded","Created At"],n=r.map(e=>{var r,t,a,n,o;return[e.booking_reference||e.id,e.passenger_name||"",e.passenger_phone||"",e.passenger_email||"",`${(null==(t=null==(r=e.trips)?void 0:r.routes)?void 0:t.origin)||""} → ${(null==(n=null==(a=e.trips)?void 0:a.routes)?void 0:n.destination)||""}`,(null==(o=e.trips)?void 0:o.departure_time)||"",e.seat_number||"",e.total_amount||0,e.payment_status||"",e.status||"",e.is_boarded?"Yes":"No",e.created_at||""]});return[a.join(","),...n.map(e=>e.map(e=>`"${String(e).replace(/"/g,'""')}"`).join(","))].join("\n")}catch(r){return t("Error exporting bookings",r),null}},subscribeToBookings(r){const t=e.channel("bookings-changes").on("postgres_changes",{event:"*",schema:"public",table:"bookings"},()=>{r()}).subscribe();return{unsubscribe:()=>{e.removeChannel(t)}}},async getBookingByReference(r){var a,n,o,i,s;try{const{data:t,error:u}=await e.from("bookings").select("\n          *,\n          schedule:schedules(\n            *,\n            route:routes(*),\n            bus:buses(*)\n          )\n        ").or(`booking_reference.eq.${r},id.eq.${r},qr_code.eq.${r}`).single();if(u){if("PGRST116"===u.code)return{data:null,error:{message:"Booking not found"}};throw u}if(!t)return{data:null,error:{message:"Booking not found"}};return{data:{id:t.id,booking_reference:t.booking_reference||t.qr_code||t.id.substring(0,8).toUpperCase(),passenger_name:t.passenger_name||"N/A",passenger_phone:t.passenger_phone||"N/A",seat_number:Array.isArray(t.seats)?t.seats.join(", "):t.seats||"N/A",payment_status:t.payment_status||"pending",is_boarded:t.is_boarded||!1,boarded_at:t.boarded_at||null,trips:{departure_time:(null==(a=t.schedule)?void 0:a.departure_time)||t.departure_time,routes:{origin:(null==(o=null==(n=t.schedule)?void 0:n.route)?void 0:o.origin)||"N/A",destination:(null==(s=null==(i=t.schedule)?void 0:i.route)?void 0:s.destination)||"N/A"}}},error:null}}catch(u){return t("Error fetching booking",u),{data:null,error:{message:u.message||"Failed to fetch booking"}}}},getPaymentStatus:e=>"paid"===e.payment_status||"confirmed"===e.status||"paid"===e.status||e.payment_method&&"cancelled"!==e.status?"paid":"pending",async getSettings(){try{const{data:r,error:t}=await e.from("settings").select("*").single();if(t&&"PGRST116"!==t.code)throw t;return{data:r||{company_name:"GOGOBUS Botswana",support_phone:"+267 12 345 678",support_email:"support@gogobus.co.bw",booking_enabled:!0,auto_confirm_bookings:!1,require_payment_upfront:!0},error:null}}catch(r){return t("Error getting settings",r),{data:{company_name:"GOGOBUS Botswana",support_phone:"+267 12 345 678",support_email:"support@gogobus.co.bw",booking_enabled:!0,auto_confirm_bookings:!1,require_payment_upfront:!0},error:null}}},async updateSettings(a){try{const{data:t,error:n}=await e.from("settings").upsert({id:1,...a,updated_at:(new Date).toISOString()}).select().single();if(n){if("42P01"===n.code)return r("Settings table does not exist. Settings changes will not persist."),{data:a,error:null};throw n}return{data:t,error:null}}catch(n){return t("Error updating settings",n),{data:a,error:null}}}};export{s as a};
