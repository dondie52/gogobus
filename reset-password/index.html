<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1B4D4A">
    <title>Reset Password - GOGOBUS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1B4D4A;
            --primary-light: #2A5F5C;
            --accent: #F5A623;
            --white: #FFFFFF;
            --black: #1A1A1A;
            --gray: #6B7280;
            --gray-light: #F3F4F6;
            --error: #EF4444;
            --success: #10B981;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: var(--primary);
            border-radius: 24px;
            padding: 40px 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 40px;
        }

        .logo svg {
            width: 40px;
            height: 40px;
        }

        .logo span {
            font-size: 24px;
            font-weight: 800;
            color: var(--white);
            letter-spacing: -0.5px;
        }

        .title {
            color: var(--white);
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            text-align: center;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--white);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .input-wrapper.error {
            border-color: var(--error);
        }

        .input-wrapper.success {
            border-color: var(--success);
        }

        .input-icon {
            position: absolute;
            left: 16px;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 16px 48px 16px 48px;
            font-size: 16px;
            color: var(--white);
            outline: none;
            width: 100%;
        }

        .input-wrapper input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .toggle-password {
            position: absolute;
            right: 16px;
            background: none;
            border: none;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.5);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-password:hover {
            color: var(--white);
        }

        .password-strength {
            margin-top: 8px;
        }

        .strength-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .strength-fill.weak { width: 33%; background: var(--error); }
        .strength-fill.medium { width: 66%; background: var(--accent); }
        .strength-fill.strong { width: 100%; background: var(--success); }

        .strength-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .input-hint {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 6px;
        }

        .error-message {
            display: block;
            font-size: 12px;
            color: var(--error);
            margin-top: 6px;
        }

        .btn-primary {
            width: 100%;
            padding: 16px 24px;
            background: var(--accent);
            color: var(--black);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .btn-primary:hover {
            background: #E69A1E;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary.loading .btn-text {
            display: none;
        }

        .btn-primary.loading .btn-loader {
            display: block !important;
        }

        .btn-loader {
            width: 20px;
            height: 20px;
            border: 2px solid var(--black);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .back-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            margin-top: 24px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--white);
        }

        /* Success State */
        .success-state {
            display: none;
            text-align: center;
            padding: 20px 0;
        }

        .success-state.active {
            display: block;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            color: var(--success);
        }

        .success-title {
            color: var(--white);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .success-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        /* Error State */
        .error-state {
            display: none;
            text-align: center;
            padding: 20px 0;
        }

        .error-state.active {
            display: block;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .error-icon svg {
            width: 40px;
            height: 40px;
            color: var(--error);
        }

        .error-title {
            color: var(--white);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .error-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--black);
            color: var(--white);
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
        }

        .toast.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Form container */
        .form-container {
            display: block;
        }

        .form-container.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="4" y="12" width="4" height="18" rx="2" fill="#F5A623"/>
                <rect x="11" y="7" width="4" height="23" rx="2" fill="#F5A623"/>
                <rect x="18" y="4" width="4" height="26" rx="2" fill="#F5A623"/>
                <rect x="25" y="9" width="4" height="21" rx="2" fill="#F5A623"/>
                <rect x="32" y="14" width="4" height="16" rx="2" fill="#F5A623"/>
            </svg>
            <span>GOGOBUS</span>
        </div>

        <!-- Form State -->
        <div class="form-container" id="form-container">
            <h1 class="title">Reset Password</h1>
            <p class="subtitle">Create a new password for your account. Make sure it's strong and secure.</p>

            <form id="reset-form" onsubmit="handleResetPassword(event)">
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <rect x="3" y="11" width="18" height="11" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M7 11V7C7 4.24 9.24 2 12 2C14.76 2 17 4.24 17 7V11" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <input type="password" id="new-password" name="password" placeholder="Enter new password" required minlength="8" oninput="checkPasswordStrength(this.value)">
                        <button type="button" class="toggle-password" onclick="togglePassword('new-password')">
                            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" style="display:none;">
                                <path d="M17.94 17.94A10.07 10.07 0 0112 20C5 20 1 12 1 12A18.45 18.45 0 015.06 6.06" stroke="currentColor" stroke-width="2"/>
                                <path d="M1 1L23 23" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strength-fill"></div>
                        </div>
                        <span class="strength-text" id="strength-text">Minimum 8 characters</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <div class="input-wrapper" id="confirm-wrapper">
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <rect x="3" y="11" width="18" height="11" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M7 11V7C7 4.24 9.24 2 12 2C14.76 2 17 4.24 17 7V11" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <input type="password" id="confirm-password" name="confirmPassword" placeholder="Confirm new password" required oninput="checkPasswordMatch()">
                        <button type="button" class="toggle-password" onclick="togglePassword('confirm-password')">
                            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" style="display:none;">
                                <path d="M17.94 17.94A10.07 10.07 0 0112 20C5 20 1 12 1 12A18.45 18.45 0 015.06 6.06" stroke="currentColor" stroke-width="2"/>
                                <path d="M1 1L23 23" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                    <span class="input-hint" id="match-hint"></span>
                </div>

                <button type="submit" class="btn-primary" id="submit-btn">
                    <span class="btn-text">Reset Password</span>
                    <span class="btn-loader" style="display:none;"></span>
                </button>
            </form>

            <a href="index.html" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Back to Login
            </a>
        </div>

        <!-- Success State -->
        <div class="success-state" id="success-state">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h2 class="success-title">Password Reset!</h2>
            <p class="success-text">Your password has been successfully reset. You can now log in with your new password.</p>
            <a href="index.html" class="btn-primary" style="text-decoration: none;">
                Go to Login
            </a>
        </div>

        <!-- Error State -->
        <div class="error-state" id="error-state">
            <div class="error-icon">
                <svg viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <h2 class="error-title">Link Expired</h2>
            <p class="error-text">This password reset link has expired or is invalid. Please request a new one.</p>
            <a href="index.html" class="btn-primary" style="text-decoration: none;">
                Back to Login
            </a>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <span class="toast-message"></span>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        // Check if we have a valid session from the reset link
        async function checkResetSession() {
            try {
                // Check URL for error parameters first
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                
                if (urlParams.get('error') || hashParams.get('error')) {
                    showErrorState();
                    return;
                }

                // Supabase handles the token from the URL hash automatically
                // Check if we have an access_token in the hash (from reset link)
                const accessToken = hashParams.get('access_token');
                const type = hashParams.get('type');
                
                // If we have a reset token, Supabase will automatically set the session
                if (accessToken && type === 'recovery') {
                    // Clear the hash after processing
                    window.location.hash = '';
                    
                    // Wait a moment for Supabase to process the token
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Check for valid session
                const session = await window.SupabaseAuth.getSession();
                
                if (!session) {
                    // If no session and no access token, show error
                    if (!accessToken) {
                        showErrorState();
                        return;
                    }
                    // If we had a token but no session, wait a bit more
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const retrySession = await window.SupabaseAuth.getSession();
                    if (!retrySession) {
                        showErrorState();
                        return;
                    }
                }
            } catch (error) {
                console.error('Check session error:', error);
                showErrorState();
            }
        }

        // Handle password reset
        async function handleResetPassword(event) {
            event.preventDefault();

            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const submitBtn = document.getElementById('submit-btn');

            // Validate
            if (password.length < 8) {
                showToast('Password must be at least 8 characters');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match');
                return;
            }

            // Show loading
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                // Use SupabaseAuth helper for consistency
                await window.SupabaseAuth.updatePassword(password);

                // Success!
                showSuccessState();
            } catch (error) {
                console.error('Reset password error:', error);
                showToast(error.message || 'Failed to reset password. Please try again.');
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            const fill = document.getElementById('strength-fill');
            const text = document.getElementById('strength-text');

            if (password.length === 0) {
                fill.className = 'strength-fill';
                text.textContent = 'Minimum 8 characters';
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            if (strength <= 1) {
                fill.className = 'strength-fill weak';
                text.textContent = 'Weak password';
            } else if (strength <= 2) {
                fill.className = 'strength-fill medium';
                text.textContent = 'Medium strength';
            } else {
                fill.className = 'strength-fill strong';
                text.textContent = 'Strong password';
            }
        }

        // Check password match
        function checkPasswordMatch() {
            const password = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            const wrapper = document.getElementById('confirm-wrapper');
            const hint = document.getElementById('match-hint');

            if (confirm.length === 0) {
                wrapper.classList.remove('error', 'success');
                hint.textContent = '';
                return;
            }

            if (password === confirm) {
                wrapper.classList.remove('error');
                wrapper.classList.add('success');
                hint.textContent = '✓ Passwords match';
                hint.style.color = 'var(--success)';
            } else {
                wrapper.classList.remove('success');
                wrapper.classList.add('error');
                hint.textContent = '✗ Passwords do not match';
                hint.style.color = 'var(--error)';
            }
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentElement.querySelector('.toggle-password');
            const eyeOpen = button.querySelector('.eye-open');
            const eyeClosed = button.querySelector('.eye-closed');

            if (input.type === 'password') {
                input.type = 'text';
                eyeOpen.style.display = 'none';
                eyeClosed.style.display = 'block';
            } else {
                input.type = 'password';
                eyeOpen.style.display = 'block';
                eyeClosed.style.display = 'none';
            }
        }

        // Show success state
        function showSuccessState() {
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('error-state').classList.remove('active');
            document.getElementById('success-state').classList.add('active');
        }

        // Show error state
        function showErrorState() {
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('success-state').classList.remove('active');
            document.getElementById('error-state').classList.add('active');
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            const messageEl = toast.querySelector('.toast-message');
            messageEl.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkResetSession();
        });
    </script>
</body>
</html>
